# Test Runner for NAT Testing
FROM rust:1.85.1-alpine3.20

# Install dependencies
RUN apk add --no-cache \
    bash \
    curl \
    jq \
    netcat-openbsd \
    tcpdump \
    iperf3 \
    git \
    musl-dev \
    openssl-dev \
    pkgconfig

# Create workspace
WORKDIR /workspace

# Copy the entire project
COPY . .

# Build test binaries
RUN cargo test --no-run --release

# Install test utilities (use older version compatible with Rust 1.85)
RUN cargo install cargo-nextest --version 0.9.100

# Create directories for test results
RUN mkdir -p /test-results /scripts

# Copy test scripts
COPY docker/scripts/ /scripts/
RUN chmod +x /scripts/*.sh

# Default environment
ENV RUST_LOG=info \
    RUST_BACKTRACE=1 \
    TEST_THREADS=1

ENTRYPOINT ["/scripts/run-enhanced-nat-tests.sh"]